# 架构与运维小技巧

> 来源：58沈剑的架构师之路，很高产的作者，很实在的知识



*1.*《[如何进行无损发布，从此不用凌晨上线](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961084&idx=1&sn=187d457c7219ec69d553dc001df8cb0b&chksm=bd2d03208a5a8a36971de641e0ff21946a83a5e242c79de61f0f7648b9f36e3e22c1d92534b1&scene=21#wechat_redirect)》

很多公司选择在晚上发布，美名其曰“对用户影响最小”，自从实现了无损发布，随时随地上线，每天按时下班，爽。

```
见原文，结合架构图很清晰。
```



*2.*《[服务挂了，怎么自动恢复？](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961088&idx=1&sn=1d63b0dd0a0ed90f94296c58cc95cd7c&chksm=bd2d02dc8a5a8bcab0fac7f4b7c9f5be7ea0061a857221e0287b00f7b6cbf5ac0f27466fbf56&scene=21#wechat_redirect)》

一分钟系列，一个互联网常见的运维工具。

```
答案：supervisor
```



*3.*《[nohup与&到底有啥用？](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961108&idx=1&sn=3fccc94c4307fa2306bae680d8570c18&chksm=bd2d02c88a5a8bde8944e383a3fb9b6d24461cf07ed5a65dbf774a2382bf1f318aca18df5572&scene=21#wechat_redirect)》

一分钟系列，彻底搞懂运维工具nohup与linux常见命令&。

```
对现象和使用方法进行了介绍，没有从操作系统原理去说明

nohup的输出重定向到一个特定的日志文件中。最好是用框架或者模块的日志工具去管理日志。
```



*4.*《[tail -f为啥看不到已答应的日志？](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961118&idx=1&sn=86e672b96f24805176b04b29958299a2&chksm=bd2d02c28a5a8bd42ace9628a2359c277d589d34de1d92055b0c5676c9d6f6067c58d095e5e4&scene=21#wechat_redirect)》

一分钟系列，彻底搞懂文件缓冲问题。



*5.*《[DB误删快速回复，DBA从此不再跑路](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961278&idx=1&sn=e4bb998d0b5d5364237a548d495bf7ad&chksm=bd2d02628a5a8b7493fd9fcf67cb8717fefd458f7488006d2294849f43e93129162564650437&scene=21#wechat_redirect)》

删了全库，也瞬间恢复，从此不再怕手抖，从此不再跑路。

```
结论：

保证数据的安全性是DBA第一要务：
（0）理论上可以恢复；
（1）全量备份+增量备份+定期演练；
（2）1小时延时从库；
（3）双份1小时延时从库+提高资源利用率；
```



*6.*《[chmod 755 究竟是什么鬼？](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961540&idx=1&sn=d1d0db692a64414d189b073096e415e4&chksm=bd2d0d188a5a840e95e84d2e32fd831b9bbef92f7d7707d86f18b248e4e79970638fd972bd97&scene=21#wechat_redirect)》

一分钟系列，权限的这一块都懂了。

**很实用、很易懂**

```
有个校招的同事问我：

(1) 使用ls –l查看文件，前面显示的-rwxrwxr-x是什么意思？

(2) chmod 755 xxx.sh又是什么意思？

1分钟简单说下，这两个和权限相关的问题。

先说下文件类型，访问方式，权限分类。

Linux下，分为这么几种文件类型：

d：目录directory

l：符号链接link

s：套接字socket

c：字符设备char

p：命名管道pipe

-：其他，不属于以上几类


文件创建后，有三种访问方式：

读(read)：显示内容

写(write)：编辑内容，删除文件

执行(execute)：执行文件


针对用户，文件有三类权限：

创建人(user)权限：创建文件的人

组(group)用户权限：和拥有者处于同一用户组的其他人

其他(other)用户权限


了解了文件类型，访问方式，三类权限之后，第一个问题就比较好解答了。


例如，上述a.out的第一列

-rwxrwxr-x

共有十个字符，分为四个部分：

第1个字符表示文件的类型：[-]表示普通文件

第234字符表示创建人的权限：[wxr]表示可读，可写，可执行

第567字符表示组用户权限：[wxr]表示可读，可写，可执行

第890字符表示其他用户权限：[r-x]表示可读，可执行

如何改变文件的权限呢？

chmod命令用于改变文件的权限，它有两种使用方法。

第一种：chomod [who] [operator] [permission] filename

[who]

u：创建人

g：组用户

o：其他用户

a：所有用户(all)


[operator]

+：增加权限

-：取消权限

=：设定权限


[permission]

r：读

w：写

x：执行


如何给一个文本文件xxx.sh增加可执行权限？

chmod u+x xxx.sh


如何不让其他用户修改xxx.sh？

chmod go-w xxx.sh


第二种方法：chmod [mode] filename


[mode]是一个3位八进制数：

第一位表示创建者权限

第二位表示组用户权限

第三位表示其他用户权限


更具体的：

400：创建者可读

200：创建者可写

100：创建者可执行

040：组用户可读

020：组用户可写

010：组用户可执行

004：其他用户可读

002：其他用户可写

001：其他用户可执行


3位对应位的对应数字加起来，最终就是三类用户的最终权限。


如何回收非创建者用户对xxx.sh的所有权限？

chmod 700 xxx.sh

第一位7：4+2+1，创建者，可读可写可执行

第二位0：组用户，无权限

第三位0：其他用户，无权限


xxx.sh只允许创建者修改，允许其他用户读取和执行，怎么设置？

chmod 755 xxx.sh

第一位7：4+2+1，创建者，可读可写可执行

第二位5：4+1，组用户，可读可执行

第三位5：4+1，其他用户，可读可执行

画外音：一般来说，写了一个工具，只允许自己修改，不允许别人修改，但允许别人使用，这就是755。


-rwxrwxr-x

chmod 755
```



*7.*《[过载保护+异构服务器负载均衡咋实施？](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961863&idx=2&sn=5060b9971b4d1a702747a01ed553c674&chksm=bd2d0fdb8a5a86cde2e29f9ed8ad6b689974ad6f48f900e96aae9b5887dfe97a47f356abf784&scene=21#wechat_redirect)》

你一定遇到过，压力过大，系统全蹦了，那能不能不全蹦？

你一定遇到过，服务器的配置不一样，此时如何做负载均衡？

**那什么是过载保护？**

**过载保护**，是指当外部负载超过系统处理能力时，系统会进行自我保护，依然能对外提供有损的稳定服务。

如果没有过载保护：

- 随着外部负载的不断升高，系统实际处理负载会增加
- 外部负载升高到一个临界值，系统会被压垮，实际处理能力会降为0

*画外音：这就是所谓的“掉底”。*

如果进行了过载保护：

- 随着外部负载的不断升高，系统实际处理负载会增加
- 外部负载即使超过一个临界值，系统不会被压垮，而能保持一定的处理能力

*画外音：外部负载无限大，系统也不会“掉底”。*



**总结**

- 负载均衡、故障转移、超时处理通常是连接池层面来实施的
- 异构服务器负载均衡，最简单的方式是静态权重法，缺点是无法自适应动态调整
- 动态权重法，可以动态的根据服务器的处理能力来分配负载，需要有连接池层面的微小改动
- 过载保护，是在负载过高时，服务器为了保护自己，保证一定处理能力的一种自救方式
- 动态权重法，还可以用做服务器的过载保护



*详情见原文*



*8.*《[php怎么搞长连接？](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961899&idx=1&sn=536dcd525bd4983635c4fc2cd429046e&chksm=bd2d0ff78a5a86e1d19d1b5b95d1d86cc91971053d93aa89baa620bcc6ee6cf912db7e8cedef&scene=21#wechat_redirect)》

一分钟系列，世界上最好的语言，提供一种长连接的思路。



*9.*《[rm -rf *  了咋办，跑路吗？](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961906&idx=1&sn=675720762919cd8220f2a819ea72164f&chksm=bd2d0fee8a5a86f8dccccd1760a931cda562a25eddfc3c5c2ad3b5d95c8919dac989ed0ab07e&scene=21#wechat_redirect)》

一分钟系列，DBA删了数据库能够恢复，OP删了文件又该如何避免呢？

**很实用！！！**

昨天有个工程师写了一个删除日志的bug：

> ...
>
> rm -rf / home/work/logs/
>
> ...

还好是在测试环境执行的，否则估计要跑路了。

*画外音：一个“多了一个空格”的bug，看懂了么？*



曾经我也干过类似的傻事，写过这样删除日志的脚本：

> ...
>
> cd ${log_path}
>
> rm -rf *
>
> ...

进入到日志目录，然后把日志都删除。

*画外音：看上去没有任何问题？当目录不存在时，悲剧就发生了。*

 

如何避免类似的删除根目录的“惨剧”发生，有这样一些建议：



**一、命令替换**

在生产环境把rm -rf 命令替换为mv，再写个定时shell定期清理。

*画外音：模拟了回收站的功能。*

 

**二、收拢权限**

帐号权限的分离，线上分配work帐号，只能够删除/home/work/logs/目录，无法删除根目录。

*画外音：大公司一般线上权限管理比较规范，小公司就未必了，搞不好所有的小伙伴都有权限在线上乱搞。*

 

**三、使用&&**

可以通过“&&”，将

cd ${log_path}

rm -rf *

合并成一个语句

cd ${log_path} && rm -rf *

当前半句执行失败的时候，后半句不再执行。

*画外音：这个小技巧很赞。*

 

**四、判断目录是否存在**

制定编码规范，对目录进行操作之前，要先判断目录是否存在。

*画外音：靠人的自觉来保证规范的执行，总感觉有些不太靠谱。当然，规范是有必要的。*



*10.*《[58到家MySQL军规升级版](http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961030&idx=1&sn=73a04dabca409c1557e752382d777181&chksm=bd2d031a8a5a8a0c6f7b58b79ae8933dfefbd840dfb5d34a5c708ab63e6decbbc1b13533ebc8&scene=21#wechat_redirect)》

58到家MySQL军规最佳实践。